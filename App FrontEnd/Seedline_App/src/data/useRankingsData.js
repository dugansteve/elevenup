// Hook to load rankings data from JSON file
// The rankings_for_react.json file is generated by team_ranker and placed in public/
// V39+: Players are now included directly in rankings_for_react.json (no separate file)

import { useState, useEffect } from 'react';

export function useRankingsData() {
  const [data, setData] = useState({
    teamsData: [],
    gamesData: [],      // Individual games for schedules
    playersData: [],    // Players from database (V39+: included in main JSON)
    ageGroups: [],
    leagues: [],
    states: [],
    genders: [],        // V39+: Boys and Girls
    lastUpdated: null,
    isLoading: true,
    error: null
  });

  useEffect(() => {
    async function loadRankings() {
      try {
        // Load rankings data (V39+ includes players)
        const response = await fetch('/rankings_for_react.json');
        if (!response.ok) {
          throw new Error('Rankings file not found. Run the team ranker to generate it.');
        }
        const jsonData = await response.json();
        const teamsData = jsonData.teamsData || [];
        
        // V39+: Players are now in the main JSON file
        let playersData = jsonData.playersData || [];
        
        // If no players in main JSON, try legacy separate file (backwards compatibility)
        if (playersData.length === 0) {
          try {
            const playersResponse = await fetch('/players_for_react.json');
            if (playersResponse.ok) {
              const playersJson = await playersResponse.json();
              playersData = playersJson.players || [];
              console.log(`Loaded ${playersData.length} players from separate file (legacy)`);
            }
          } catch (playersErr) {
            console.log('No separate players file found');
          }
        } else {
          console.log(`Loaded ${playersData.length} players from rankings JSON`);
        }
        
        // Extract unique values from data if not provided in JSON
        const extractedAgeGroups = jsonData.ageGroups || 
          [...new Set(teamsData.map(t => t.ageGroup).filter(Boolean))].sort((a, b) => {
            // Sort by gender (G first, then B), then by number descending
            const aGender = a.charAt(0);
            const bGender = b.charAt(0);
            if (aGender !== bGender) return aGender === 'G' ? -1 : 1;
            // Extract number part and compare
            const aNum = parseInt(a.replace(/\D/g, '')) || 0;
            const bNum = parseInt(b.replace(/\D/g, '')) || 0;
            return bNum - aNum; // Descending (older first)
          });
        
        const extractedLeagues = jsonData.leagues || 
          [...new Set(teamsData.map(t => t.league).filter(Boolean))].sort();
        
        // Ensure NPL is included in leagues (added by user request)
        const leaguesWithNPL = extractedLeagues.includes('NPL') 
          ? extractedLeagues 
          : [...extractedLeagues, 'NPL'].sort();
        
        const extractedStates = jsonData.states || 
          [...new Set(teamsData.map(t => t.state).filter(Boolean))].sort();
        
        // V39+: Use genders from JSON, or extract from age groups
        const extractedGenders = jsonData.genders || 
          [...new Set(teamsData.map(t => {
            if (t.gender) return t.gender;  // V39+: gender field
            if (!t.ageGroup) return null;
            const firstChar = t.ageGroup.charAt(0).toUpperCase();
            if (firstChar === 'G') return 'Girls';
            if (firstChar === 'B') return 'Boys';
            return null;
          }).filter(Boolean))].sort();
        
        setData({
          teamsData: teamsData.map(team => ({
            ...team,
            // Calculate GPG and GAPG if not already present
            goalsPerGame: team.goalsPerGame || (team.gamesPlayed > 0 
              ? parseFloat((team.goalsFor / team.gamesPlayed).toFixed(2)) 
              : 0),
            goalsAgainstPerGame: team.goalsAgainstPerGame || (team.gamesPlayed > 0 
              ? parseFloat((team.goalsAgainst / team.gamesPlayed).toFixed(2)) 
              : 0),
            // Use existing off/def power or default to 50
            offensivePowerScore: team.offensivePowerScore || team.offPower || 50,
            defensivePowerScore: team.defensivePowerScore || team.defPower || 50,
          })),
          gamesData: jsonData.gamesData || [],
          playersData: playersData,
          ageGroups: extractedAgeGroups,
          leagues: leaguesWithNPL,
          states: extractedStates,
          genders: extractedGenders,
          lastUpdated: jsonData.lastUpdated || null,
          isLoading: false,
          error: null
        });
      } catch (err) {
        console.error('Error loading rankings:', err);
        setData(prev => ({
          ...prev,
          isLoading: false,
          error: err.message
        }));
      }
    }

    loadRankings();
  }, []);

  return data;
}

export default useRankingsData;
