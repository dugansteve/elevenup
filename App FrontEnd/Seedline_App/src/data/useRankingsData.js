// Hook to load rankings data from API or JSON file
// The rankings_for_react.json file is generated by team_ranker and placed in public/
// V39+: Players are now included directly in rankings_for_react.json (no separate file)
// V51+: Progressive loading - API first (fast), then full JSON in background
// V52+: Cache-busting with timestamp to prevent stale data

import { useState, useEffect, useRef } from 'react';

// Cache-busting: Add timestamp to prevent browser caching of JSON files
// Using a 15-minute window so users don't re-download on every page load
const getCacheBuster = () => {
  const now = Date.now();
  const window15min = Math.floor(now / (15 * 60 * 1000));
  return `v=${window15min}`;
};

import { api } from '../services/api';

// Progressive loading: Load 100 teams from API first, then full data in background
// TEMPORARILY DISABLED - use static JSON for reliable loading
const ENABLE_PROGRESSIVE_LOADING = false;
const INITIAL_LOAD_LIMIT = 100;

// Map full state names to 2-letter abbreviations
const STATE_ABBREVIATIONS = {
  'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
  'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
  'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
  'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
  'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
  'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
  'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
  'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
  'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
  'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY',
  'district of columbia': 'DC', 'puerto rico': 'PR'
};

// Convert state to 2-letter abbreviation
function toStateAbbreviation(state) {
  if (!state) return null;
  const trimmed = state.trim();
  // Already a 2-letter abbreviation
  if (/^[A-Z]{2}$/.test(trimmed)) return trimmed;
  // Look up full name
  const abbrev = STATE_ABBREVIATIONS[trimmed.toLowerCase()];
  return abbrev || null; // Return null for unrecognized values
}

export function useRankingsData() {
  const [data, setData] = useState({
    teamsData: [],
    gamesData: [],      // Individual games for schedules
    playersData: [],    // Players from database (V39+: included in main JSON)
    rankingsHistory: {}, // Historical rankings by team ID
    ageGroups: [],
    leagues: [],
    states: [],
    genders: [],        // V39+: Boys and Girls
    lastUpdated: null,
    isLoading: true,
    isLoadingFull: false,  // V51: Loading full dataset in background
    error: null
  });

  const fullDataLoadedRef = useRef(false);

  useEffect(() => {
    // Phase 1: Quick initial load from API (100 teams + metadata)
    async function loadInitialData() {
      try {
        console.log('[Rankings] Phase 1: Loading initial data from API...');
        const startTime = performance.now();

        // Add timeout to prevent hanging
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('API timeout')), 5000)
        );
        const apiResponse = await Promise.race([
          api.getRankings({ limit: INITIAL_LOAD_LIMIT }),
          timeoutPromise
        ]);

        if (apiResponse && apiResponse.teams && apiResponse.teams.length > 0) {
          const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
          console.log(`[Rankings] Phase 1 complete: ${apiResponse.teams.length} teams in ${loadTime}s`);

          // Use metadata from API (extracted from full dataset on server)
          setData(prev => ({
            ...prev,
            teamsData: normalizeTeams(apiResponse.teams),
            ageGroups: apiResponse.ageGroups || [],
            genders: apiResponse.genders || [],
            leagues: ensureNPL(apiResponse.leagues || []),
            states: apiResponse.states || [],
            lastUpdated: apiResponse.lastUpdated,
            isLoading: false,
            isLoadingFull: true,  // Will load full data in background
          }));

          return true;
        }
      } catch (err) {
        console.warn('[Rankings] API unavailable:', err.message);
      }
      return false;
    }

    // Phase 2: Load full dataset from static JSON in background
    async function loadFullData() {
      if (fullDataLoadedRef.current) return;
      fullDataLoadedRef.current = true;

      try {
        console.log('[Rankings] Phase 2: Loading full dataset in background...');
        const startTime = performance.now();

        const response = await fetch(`/rankings_for_react.json?${getCacheBuster()}`);
        if (!response.ok) {
          throw new Error('Rankings file not found');
        }

        const jsonData = await response.json();
        const teamsData = jsonData.teamsData || [];
        const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
        console.log(`[Rankings] Phase 2 complete: ${teamsData.length} teams in ${loadTime}s`);

        // Load players
        let playersData = jsonData.playersData || [];
        if (playersData.length === 0) {
          try {
            const playersResponse = await fetch(`/players_for_react.json?${getCacheBuster()}`);
            if (playersResponse.ok) {
              const playersJson = await playersResponse.json();
              playersData = playersJson.players || [];
            }
          } catch (e) { /* ignore */ }
        }

        // Load rankings history
        let rankingsHistory = {};
        try {
          const historyResponse = await fetch(`/rankings_history.json?${getCacheBuster()}`);
          if (historyResponse.ok) {
            const historyJson = await historyResponse.json();
            rankingsHistory = historyJson.history || {};
          }
        } catch (e) { /* ignore */ }

        // Update with full data
        setData(prev => ({
          ...prev,
          teamsData: normalizeTeams(teamsData),
          gamesData: jsonData.gamesData || [],
          playersData: playersData,
          rankingsHistory: rankingsHistory,
          ageGroups: extractAgeGroups(jsonData, teamsData),
          leagues: ensureNPL(extractLeagues(jsonData, teamsData)),
          states: extractStates(jsonData, teamsData),
          genders: extractGenders(jsonData, teamsData),
          lastUpdated: jsonData.lastUpdated || prev.lastUpdated,
          isLoadingFull: false,
        }));

      } catch (err) {
        console.error('[Rankings] Error loading full data:', err);
        setData(prev => ({
          ...prev,
          isLoadingFull: false,
          error: prev.teamsData.length > 0 ? null : err.message,
        }));
      }
    }

    // Fallback: Load directly from static JSON if API fails
    async function loadFromStaticJSON() {
      console.log('[Rankings] Loading from static JSON...');
      fullDataLoadedRef.current = true;

      try {
        // First try the light file (teams only, ~25MB)
        // Then load players/games in background
        const startTime = performance.now();
        let response = await fetch(`/rankings_light.json?${getCacheBuster()}`);

        // Fall back to full file if light doesn't exist
        if (!response.ok) {
          console.log('[Rankings] Light file not found, using full file...');
          response = await fetch(`/rankings_for_react.json?${getCacheBuster()}`);
        }

        if (!response.ok) {
          throw new Error('Rankings file not found. Run the team ranker to generate it.');
        }

        const jsonData = await response.json();
        const teamsData = jsonData.teamsData || [];
        const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
        console.log(`[Rankings] Loaded ${teamsData.length} teams in ${loadTime}s`);

        // Set data immediately with just teams
        setData({
          teamsData: normalizeTeams(teamsData),
          gamesData: [],  // Load later
          playersData: [], // Load later
          rankingsHistory: {},
          ageGroups: extractAgeGroups(jsonData, teamsData),
          leagues: ensureNPL(extractLeagues(jsonData, teamsData)),
          states: extractStates(jsonData, teamsData),
          genders: extractGenders(jsonData, teamsData),
          lastUpdated: jsonData.lastUpdated || null,
          isLoading: false,
          isLoadingFull: true,  // Still loading players/games
          error: null
        });

        // Load players and games in background
        setTimeout(async () => {
          try {
            console.log('[Rankings] Loading players and games in background...');
            const [fullResp, historyResp] = await Promise.all([
              fetch(`/rankings_for_react.json?${getCacheBuster()}`).catch(() => null),
              fetch(`/rankings_history.json?${getCacheBuster()}`).catch(() => null)
            ]);

            let playersData = [];
            let gamesData = [];
            let rankingsHistory = {};

            if (fullResp?.ok) {
              const fullData = await fullResp.json();
              playersData = fullData.playersData || [];
              gamesData = fullData.gamesData || [];
              console.log(`[Rankings] Loaded ${playersData.length} players, ${gamesData.length} games`);
            }

            if (historyResp?.ok) {
              const hj = await historyResp.json();
              rankingsHistory = hj.history || {};
            }

            setData(prev => ({
              ...prev,
              playersData,
              gamesData,
              rankingsHistory,
              isLoadingFull: false
            }));
          } catch (e) {
            console.warn('[Rankings] Background load failed:', e);
            setData(prev => ({ ...prev, isLoadingFull: false }));
          }
        }, 100);

      } catch (err) {
        console.error('Error loading rankings:', err);
        setData(prev => ({
          ...prev,
          isLoading: false,
          isLoadingFull: false,
          error: err.message
        }));
      }
    }

    // Execute progressive loading
    async function init() {
      if (ENABLE_PROGRESSIVE_LOADING) {
        const apiSuccess = await loadInitialData();
        if (apiSuccess) {
          // Load full data in background after a short delay
          setTimeout(loadFullData, 100);
        } else {
          // API failed, fall back to static JSON
          await loadFromStaticJSON();
        }
      } else {
        // Progressive loading disabled, load everything from static JSON
        await loadFromStaticJSON();
      }
    }

    init();
  }, []);

  // Helper functions
  function normalizeTeams(teams) {
    return teams.map(team => ({
      ...team,
      state: toStateAbbreviation(team.state) || team.state,
      goalsPerGame: team.goalsPerGame || (team.gamesPlayed > 0
        ? parseFloat((team.goalsFor / team.gamesPlayed).toFixed(2))
        : 0),
      goalsAgainstPerGame: team.goalsAgainstPerGame || (team.gamesPlayed > 0
        ? parseFloat((team.goalsAgainst / team.gamesPlayed).toFixed(2))
        : 0),
      offensivePowerScore: team.offensivePowerScore || team.offPower || 50,
      defensivePowerScore: team.defensivePowerScore || team.defPower || 50,
    }));
  }

  function extractAgeGroups(jsonData, teamsData) {
    return jsonData.ageGroups ||
      [...new Set(teamsData.map(t => t.ageGroup).filter(Boolean))].sort((a, b) => {
        const aGender = a.charAt(0);
        const bGender = b.charAt(0);
        if (aGender !== bGender) return aGender === 'G' ? -1 : 1;
        const aNum = parseInt(a.replace(/\D/g, '')) || 0;
        const bNum = parseInt(b.replace(/\D/g, '')) || 0;
        return bNum - aNum;
      });
  }

  function extractLeagues(jsonData, teamsData) {
    return jsonData.leagues ||
      [...new Set(teamsData.map(t => t.league).filter(Boolean))].sort();
  }

  function ensureNPL(leagues) {
    return leagues.includes('NPL') ? leagues : [...leagues, 'NPL'].sort();
  }

  function extractStates(jsonData, teamsData) {
    return jsonData.states
      ? [...new Set(jsonData.states.map(s => toStateAbbreviation(s)).filter(Boolean))].sort()
      : [...new Set(teamsData.map(t => toStateAbbreviation(t.state)).filter(Boolean))].sort();
  }

  function extractGenders(jsonData, teamsData) {
    return jsonData.genders ||
      [...new Set(teamsData.map(t => {
        if (t.gender) return t.gender;
        if (!t.ageGroup) return null;
        const firstChar = t.ageGroup.charAt(0).toUpperCase();
        if (firstChar === 'G') return 'Girls';
        if (firstChar === 'B') return 'Boys';
        return null;
      }).filter(Boolean))].sort();
  }

  return data;
}

export default useRankingsData;
